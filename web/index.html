<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1">
<title>fend</title>
<script src="pkg/fend_wasm.js"></script>
<style>
    * {
        background: inherit;
        color: inherit;
        border: none;
        font-weight: inherit;
        font-size: inherit;
        font-style: inherit;
        margin: 0;
        padding: 0;
    }

    body {
        font: 16px/150% monospace;
        background: hsl(30, 15%, 90%);
        color: hsl(30, 25%, 10%);
        margin: 0;
    }

    a {
        color: hsl(90, 70%, 30%);
    }

    @media (prefers-color-scheme: dark) {
        a {
            color: hsl(90, 70%, 70%);
        }

        body {
            background: hsl(30, 25%, 10%);
            color: hsl(30, 15%, 90%);
        }
    }

    main {
        display: grid;
        grid-template-columns: auto auto;
        grid-template-rows: auto auto auto;
        max-width: 60ch;
        padding: 3ch;
        margin: auto;
    }

    main > * {
        grid-column: 1/3;
    }

    #output {
        grid-row: 2;
    }
    #output p {
        white-space: pre-wrap;
    }

    #input {
        display: grid;
        grid-template-columns: 2ch 1fr;
        grid-template-rows: auto auto;
        grid-row: 3;
    }
    #input p {
        grid-column: 1/3;
        grid-row: 2;
        margin-top: -2.5ch;
    }
    #input:before {
        content: ">";
    }
    #input #text {
        display: grid;
        grid-column: 2;
        grid-row: 1;
    }
    #input #text textarea {
        line-height: inherit;
        font-family: inherit;
        outline: none;
        overflow: hidden;
        resize: none;
    }
    #input #text:after {
        content: attr(data-replicated-value) " ";
        visibility: hidden;
    }
    #input #text textarea,
    #input #text:after {
        grid-area: 1 / 1 / 2 / 2;
        white-space: pre-wrap;
    }
</style>
<main>
    <h1 id="about">
        <a rel="noreferrer noopener" href="https://github.com/printfn/fend/wiki">fend</a> is an arbitrary-precision unit-aware calculator.
    </h1>
    <div id="input">
        <div id="text">
            <textarea autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" id="input-text" oninput="update()" onkeypress="submit(event)" autofocus></textarea>
        </div>
        <p id="input-hint"></p>
    </div>
    <div id="output">
        <p id="examples">&#10;<b>examples:</b>
    > 5'10" to cm
    177.8 cm
    > cos (pi/4) + i * (sin (pi/4))
    approx. 0.7071067811 + 0.7071067811i
    > 0b1001 + 3
    0b1100
    > 0xffff to decimal
    65535
    > 100 °C to °F
    212 °F
    > 1 lightyear to parsecs
    approx. 0.3066013937 parsecs&#10;&#10;</p>
    </div>
</main>
<script>
    let wasmInitialised = false;

    async function evaluateFend(input) {
        const { initialise, evaluateFendWithTimeout } = wasm_bindgen;

        if (!wasmInitialised) {
            await wasm_bindgen('./pkg/fend_wasm_bg.wasm');

            initialise();
            
            evaluateFendWithTimeout("1 + 2", 500);
            wasmInitialised = true;
        }

        return evaluateFendWithTimeout(input, 500);
    }

    async function submit(event) {
        let input = document.getElementById("input-text");

        if (event.keyCode == 13 && !event.shiftKey && !event.ctrlKey && !event.metaKey) {
            event.preventDefault();

            let hint = document.getElementById("input-hint");
            let output = document.getElementById("output");
            let request = document.createElement("p");
            let result = document.createElement("p");

            request.innerText = "> " + input.value;
            result.innerText = await evaluateFend(input.value);

            output.appendChild(request);
            output.appendChild(result);

            input.value = "";
            hint.innerText = "";
        }
    }

    async function update() {
        let input = document.getElementById("input-text");
        let hint = document.getElementById("input-hint");

        input.parentNode.dataset.replicatedValue = input.value;

        let result = await evaluateFend(input.value);

        if (!result.startsWith('Error: ')) {
            hint.innerText = result;
        } else {
            hint.innerText = "";
        }
    }

    async function load() {
        await wasm_bindgen('./pkg/fend_wasm_bg.wasm');

        initialise();
        
        evaluateFendWithTimeout("1 + 2", 500);
        wasmInitialised = true;
    };

    window.onload = load;
    window.onhashchange = load;
</script>